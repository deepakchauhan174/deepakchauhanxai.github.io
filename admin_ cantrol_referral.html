<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin — Referral Control</title>
<style>
  :root{ --bg:#0b1220; --card:#121a2b; --line:#1c2740; --ink:#e9edf5; --muted:#a6b0c3; --accent:#2dd4bf; }
  *{box-sizing:border-box}
  body{font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);margin:0}
  .wrap{max-width:1150px;margin:0 auto;padding:16px}
  h1,h2,h3,h4{margin:10px 0}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0}
  input,button,select,textarea{background:#0f1627;color:var(--ink);border:1px solid #223154;border-radius:10px;padding:9px 12px}
  textarea{width:100%}
  button{cursor:pointer}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .row4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:980px){ .row,.row3,.row4{grid-template-columns:1fr} }
  .ok{color:#34d399}.err{color:#f87171}.muted{color:var(--muted);font-size:13px}
  .chip{background:#1b2540;border:1px solid #24345b;padding:4px 8px;border-radius:8px;font-size:12px;display:inline-block}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #1c2740;font-size:14px}
  th{background:#0f1627;text-align:left}
  .toolbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  .pill{background:#1b2540;border:1px solid #24345b;padding:6px 10px;border-radius:999px;font-size:12px}
  .kpi{background:#16213a;border:1px solid #26406b;border-radius:12px;padding:12px}
  .kpi .val{font-size:22px;font-weight:800}
  .btn-ghost{background:transparent;border:1px dashed #29406b}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <h1>Admin Panel</h1>
    <span class="pill">Deepak × AI Bhai</span>
  </div>

  <!-- Admin Key -->
  <div class="card">
    <h2>Admin Key</h2>
    <div class="row">
      <input id="adminkey" placeholder="X-ADMIN-KEY" />
      <button id="saveKey">Save</button>
    </div>
    <div id="keyMsg" class="muted"></div>
  </div>

  <!-- Work Create -->
  <div class="card">
    <h2>Work Create (Pending)</h2>
    <div class="row3">
      <input id="wc_email" placeholder="User Email" />
      <input id="wc_amt" type="number" placeholder="Amount (₹)" />
      <input id="wc_note" placeholder="Note" />
    </div>
    <button id="wc_btn">Create</button>
    <div id="wc_msg" class="muted"></div>
  </div>

  <!-- Work Approve/Reject/Reverse -->
  <div class="card">
    <h2>Work Approve / Reject / Reverse</h2>
    <div class="row3">
      <input id="wa_id" type="number" placeholder="Work ID" />
      <select id="wa_action">
        <option value="APPROVE">APPROVE</option>
        <option value="REJECT">REJECT</option>
        <option value="REVERSE">REVERSE</option>
      </select>
      <input id="wa_note" placeholder="Note" />
    </div>
    <button id="wa_btn">Submit</button>
    <div id="wa_msg" class="muted"></div>
  </div>

  <!-- Leaderboard Control -->
  <div class="card">
    <h2>Leaderboard Control</h2>
    <div class="row3">
      <input id="lb_slot" type="number" placeholder="Slot (1..10)" />
      <input id="lb_email" placeholder="User Email" />
      <select id="lb_mode">
        <option value="pin">pin</option>
        <option value="unpin">unpin</option>
        <option value="visibility">visibility</option>
      </select>
    </div>
    <div class="row">
      <input id="lb_visible" type="number" placeholder="visible (1/0 for visibility)" />
      <button id="lb_btn">Apply</button>
    </div>
    <div id="lb_msg" class="muted"></div>
  </div>

  <!-- Manual Wallet Adjust -->
  <div class="card">
    <h2>Manual Wallet Adjust</h2>
    <div class="row3">
      <input id="ma_email" placeholder="User Email" />
      <select id="ma_type">
        <option value="CREDIT">CREDIT</option>
        <option value="DEBIT">DEBIT</option>
      </select>
      <input id="ma_amt" type="number" placeholder="Amount (₹)" />
    </div>
    <div class="row">
      <input id="ma_note" placeholder="Reason / Note" />
      <button id="ma_btn">Adjust</button>
    </div>
    <div id="ma_msg" class="muted"></div>
  </div>

  <!-- Members Console -->
  <div class="card">
    <h2>Members</h2>
    <div class="row">
      <input id="m_q" placeholder="Search name/email/ref code" />
      <div class="row">
        <button id="m_search">Search</button>
        <button id="m_reset">Reset</button>
      </div>
    </div>
    <div class="muted" id="m_meta"></div>

    <div style="margin-top:10px; overflow:auto; max-height:380px; border:1px solid #1c2740; border-radius:10px;">
      <table>
        <thead>
          <tr>
            <th>Name</th><th>Email</th><th>Ref Code</th>
            <th style="text-align:right">Joinings</th>
            <th style="text-align:right">Balance (₹)</th>
            <th style="text-align:right">Action</th>
          </tr>
        </thead>
        <tbody id="m_rows"></tbody>
      </table>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="m_prev" class="btn-ghost">Prev</button>
      <button id="m_next" class="btn-ghost">Next</button>
    </div>
  </div>

  <!-- Member Details Panel -->
  <div class="card" id="md_panel" style="display:none">
    <h2>Member Details</h2>
    <div class="muted" id="md_head"></div>

    <div class="row3" style="margin-top:10px">
      <div class="kpi"><h4>Direct Joinings</h4><div class="val" id="md_joinings">0</div></div>
      <div class="kpi"><h4>Balance</h4><div class="val">₹<span id="md_balance">0.00</span></div></div>
      <div class="kpi"><h4>Total Commission</h4><div class="val">₹<span id="md_totalc">0.00</span></div></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <h4>Quick Actions</h4>
        <div class="row">
          <select id="md_adj_type"><option value="CREDIT">CREDIT</option><option value="DEBIT">DEBIT</option></select>
          <input id="md_adj_amt" type="number" placeholder="₹ Amount" />
        </div>
        <div class="row">
          <input id="md_adj_note" placeholder="Reason/Note" />
          <button id="md_adj_btn">Apply</button>
        </div>

        <div class="row" style="margin-top:10px">
          <select id="md_vis_val">
            <option value="1">Visible in Leaderboard</option>
            <option value="0">Hide from Leaderboard</option>
          </select>
          <button id="md_vis_btn">Save Visibility</button>
        </div>

        <div class="row" style="margin-top:10px">
          <input id="md_work_amt" type="number" placeholder="Work Amount ₹" />
          <input id="md_work_note" placeholder="Work Note" />
        </div>
        <div class="row">
          <button id="md_work_create">Create Work</button>
        </div>
      </div>

      <div>
        <h4>Recent Wallet</h4>
        <ul class="muted" id="md_wallet" style="list-style:none;padding:0;margin:0"></ul>
      </div>

      <div>
        <h4>Recent Works</h4>
        <ul class="muted" id="md_works" style="list-style:none;padding:0;margin:0"></ul>
      </div>
    </div>

    <div style="margin-top:10px">
      <h4>Direct Referees (last 50)</h4>
      <ul class="muted" id="md_refs" style="list-style:none;padding:0;margin:0"></ul>
    </div>
  </div>

  <!-- Broadcast Popup (Multi-CTAs) -->
  <div class="card">
    <h2>Broadcast Popup</h2>
    <div class="row">
      <select id="bc_enabled"><option value="true">Enabled</option><option value="false">Disabled</option></select>
      <select id="bc_typing"><option value="true">Typing Title ON</option><option value="false">Typing Title OFF</option></select>
    </div>
    <div class="row">
      <input id="bc_title" placeholder="Title" />
      <input id="bc_name" placeholder="Name Tag (e.g., Deepak Chauhan)" />
    </div>
    <div class="row">
      <input id="bc_footer" placeholder="Footer (— Admin Team)" />
      <select id="bc_audience">
        <option value="all">Audience: All</option>
        <option value="loggedin">Audience: Logged-in</option>
        <option value="new">Audience: New Users</option>
      </select>
    </div>

    <div style="margin-top:10px">
      <h4>Message (HTML allowed)</h4>
      <textarea id="bc_text" rows="5" placeholder="<p>…</p>"></textarea>
    </div>

    <div style="margin-top:10px">
      <h4>Media (image/gif/sticker)</h4>
      <div id="bc_media"></div>
      <button id="bc_add_media" class="btn-ghost">+ Add Media</button>
    </div>

    <div style="margin-top:10px">
      <h4>Buttons (CTAs)</h4>
      <div id="bc_ctas"></div>
      <div class="row" style="margin-top:6px">
        <button id="bc_add_cta" class="btn-ghost">+ Add CTA</button>
        <button id="bc_add_whatsapp" class="btn-ghost">+ Add WhatsApp</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="bc_load">Load Current</button>
      <button id="bc_save">Save</button>
      <button id="bc_preview">Preview Popup</button>
    </div>
    <div id="bc_msg" class="muted"></div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const API_BASE = 'https://deepakchauhanxai.xyz/referral/api';
const H = ()=>({'Content-Type':'application/json','X-ADMIN-KEY':(localStorage.getItem('admin_key')||'')});

/* ========= Admin Key ========= */
document.getElementById('adminkey').value = localStorage.getItem('admin_key')||'';
document.getElementById('saveKey').onclick = ()=>{
  localStorage.setItem('admin_key', document.getElementById('adminkey').value.trim());
  document.getElementById('keyMsg').innerHTML='<span class="ok">Saved</span>';
};

/* ========= Work Create ========= */
document.getElementById('wc_btn').onclick = async ()=>{
  const email = document.getElementById('wc_email').value.trim().toLowerCase();
  const amount_rupees = parseFloat(document.getElementById('wc_amt').value||'0');
  const note = document.getElementById('wc_note').value.trim();
  const res = await fetch(API_BASE+'/work_create.php',{method:'POST',headers:H(),body:JSON.stringify({email,amount_rupees,note})});
  const j = await res.json();
  document.getElementById('wc_msg').textContent = j.ok? ('Created work #'+j.data.work_id): (j.error||'Error');
};

/* ========= Work Approve/Reject/Reverse ========= */
document.getElementById('wa_btn').onclick = async ()=>{
  const work_id = parseInt(document.getElementById('wa_id').value||'0');
  const action = document.getElementById('wa_action').value;
  const note = document.getElementById('wa_note').value.trim();
  const res = await fetch(API_BASE+'/work_approve.php',{method:'POST',headers:H(),body:JSON.stringify({work_id,action,note})});
  const j = await res.json();
  document.getElementById('wa_msg').textContent = j.ok? ('Status: '+j.data.status): (j.error||'Error');
};

/* ========= Leaderboard Control ========= */
document.getElementById('lb_btn').onclick = async ()=>{
  const mode = document.getElementById('lb_mode').value;
  let payload = {mode};
  if(mode==='pin'){ payload.slot=parseInt(document.getElementById('lb_slot').value||'0'); payload.email=document.getElementById('lb_email').value.trim().toLowerCase(); }
  if(mode==='unpin'){ payload.slot=parseInt(document.getElementById('lb_slot').value||'0'); }
  if(mode==='visibility'){ payload.email=document.getElementById('lb_email').value.trim().toLowerCase(); payload.visible=parseInt(document.getElementById('lb_visible').value||'1'); }
  const res = await fetch(API_BASE+'/leaderboard_pin.php',{method:'POST',headers:H(),body:JSON.stringify(payload)});
  const j = await res.json();
  document.getElementById('lb_msg').textContent = j.ok? 'Done' : (j.error||'Error');
};

/* ========= Manual Adjust ========= */
document.getElementById('ma_btn').onclick = async ()=>{
  const email = document.getElementById('ma_email').value.trim().toLowerCase();
  const type = document.getElementById('ma_type').value;
  const amount_rupees = parseFloat(document.getElementById('ma_amt').value||'0');
  const note = document.getElementById('ma_note').value.trim();
  const res = await fetch(API_BASE+'/manual_adjust.php',{method:'POST',headers:H(),body:JSON.stringify({email,type,amount_rupees,note})});
  const j = await res.json();
  document.getElementById('ma_msg').textContent = j.ok? 'Adjusted' : (j.error||'Error');
};

/* ========= Members Console ========= */
let M_PAGE = 1, M_LIMIT = 20, MD_EMAIL = '';
function fmtINR(paise){ return (paise/100).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}); }

async function loadMembers(){
  const q = document.getElementById('m_q').value.trim();
  const url = `${API_BASE}/users_list.php?q=${encodeURIComponent(q)}&page=${M_PAGE}&limit=${M_LIMIT}`;
  const res = await fetch(url, { headers: H() }); const j = await res.json();
  if(!j.ok){ document.getElementById('m_meta').textContent = j.error || 'Error'; return; }

  const rows = j.data.users || [];
  const tb = document.getElementById('m_rows'); tb.innerHTML='';
  rows.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${u.name||''}</td>
      <td style="word-break:break-all">${u.email||''}</td>
      <td><span class="chip">${u.referral_code||''}</span></td>
      <td style="text-align:right">${u.direct_joinings}</td>
      <td style="text-align:right">₹${fmtINR(u.balance_paise||0)}</td>
      <td style="text-align:right"><button class="view-btn" data-email="${u.email}">View</button></td>
    `;
    tb.appendChild(tr);
  });
  document.getElementById('m_meta').textContent = `Total: ${j.data.total} • Page ${j.data.page}`;
  document.querySelectorAll('.view-btn').forEach(b=> b.onclick = ()=> openMember(b.getAttribute('data-email')));
}

async function openMember(email){
  MD_EMAIL = email;
  const res = await fetch(`${API_BASE}/user_details.php?email=${encodeURIComponent(email)}`, { headers: H() });
  const j = await res.json(); if(!j.ok){ alert(j.error||'Error'); return; }

  const me = j.data.user, k = j.data.kpi;
  document.getElementById('md_head').textContent = `${me.name} • ${me.email} • Ref: ${me.referral_code}`;
  document.getElementById('md_joinings').textContent = k.direct_joinings;
  document.getElementById('md_balance').textContent = fmtINR(k.balance_paise||0);
  document.getElementById('md_totalc').textContent = fmtINR(k.total_commission_paise||0);

  const wul = document.getElementById('md_wallet'); wul.innerHTML='';
  (j.data.wallet_recent||[]).forEach(x=>{
    const ru = fmtINR(x.amount_paise||0);
    const sign = x.type==='CREDIT'?'+':'–';
    const li = document.createElement('li');
    li.innerHTML = `<span>${x.note||x.ref_type} <span class="muted">#${x.id}</span></span><span>${sign}₹${ru}</span>`;
    wul.appendChild(li);
  });

  const wl = document.getElementById('md_works'); wl.innerHTML='';
  (j.data.works_recent||[]).forEach(w=>{
    const amt = fmtINR(w.base_earning_paise||0);
    const li = document.createElement('li');
    li.innerHTML = `<span>#${w.id} — ${w.status}</span><span class="muted">₹${amt}</span>`;
    wl.appendChild(li);
  });

  const rl = document.getElementById('md_refs'); rl.innerHTML='';
  (j.data.direct_referees||[]).forEach(r=>{
    const dt = r.created_at ? new Date(r.created_at.replace(' ','T')).toLocaleDateString('en-IN') : '';
    const li = document.createElement('li');
    li.innerHTML = `<span>${r.name||'User'} <span class="muted">${r.email}</span></span><span class="muted">${dt}</span>`;
    rl.appendChild(li);
  });

  document.getElementById('md_panel').style.display = 'block';
}

document.getElementById('m_search').onclick = ()=>{ M_PAGE=1; loadMembers(); };
document.getElementById('m_reset').onclick = ()=>{ document.getElementById('m_q').value=''; M_PAGE=1; loadMembers(); };
document.getElementById('m_prev').onclick = ()=>{ if(M_PAGE>1){ M_PAGE--; loadMembers(); } };
document.getElementById('m_next').onclick = ()=>{ M_PAGE++; loadMembers(); };

/* ========= Member Quick Actions ========= */
document.getElementById('md_adj_btn').onclick = async ()=>{
  if(!MD_EMAIL) return;
  const type = document.getElementById('md_adj_type').value;
  const amount_rupees = parseFloat(document.getElementById('md_adj_amt').value||'0');
  const note = document.getElementById('md_adj_note').value.trim();
  const res = await fetch(`${API_BASE}/manual_adjust.php`, { method:'POST', headers: H(), body: JSON.stringify({email:MD_EMAIL,type,amount_rupees,note})});
  const j = await res.json(); alert(j.ok?'Adjusted':(j.error||'Error'));
  if(j.ok){ openMember(MD_EMAIL); loadMembers(); }
};

document.getElementById('md_vis_btn').onclick = async ()=>{
  if(!MD_EMAIL) return;
  const visible = parseInt(document.getElementById('md_vis_val').value||'1');
  const res = await fetch(`${API_BASE}/leaderboard_pin.php`, { method:'POST', headers: H(), body: JSON.stringify({mode:'visibility', email:MD_EMAIL, visible})});
  const j = await res.json(); alert(j.ok?'Saved':(j.error||'Error'));
};

document.getElementById('md_work_create').onclick = async ()=>{
  if(!MD_EMAIL) return;
  const amount_rupees = parseFloat(document.getElementById('md_work_amt').value||'0');
  const note = document.getElementById('md_work_note').value.trim();
  const res = await fetch(`${API_BASE}/work_create.php`, { method:'POST', headers: H(), body: JSON.stringify({email:MD_EMAIL, amount_rupees, note})});
  const j = await res.json(); alert(j.ok?('Work #'+j.data.work_id+' created'):(j.error||'Error'));
  if(j.ok){ openMember(MD_EMAIL); }
};

/* ========= Broadcast Admin (multi-CTAs) ========= */
function BC_h(){ return {'Content-Type':'application/json','X-ADMIN-KEY':(localStorage.getItem('admin_key')||'')}; }
const BC_API = API_BASE + '/broadcast.php';

function bc_ctaRow(label='', href=''){
  const wrap = document.createElement('div');
  wrap.style = 'display:grid;grid-template-columns:200px 1fr 80px;gap:8px;margin:6px 0';
  wrap.innerHTML = `
    <input class="bc_c_label" placeholder="Label (e.g., Join WhatsApp)" value="${label||''}">
    <input class="bc_c_href" placeholder="https://..." value="${href||''}">
    <button class="bc_c_del">Delete</button>
  `;
  wrap.querySelector('.bc_c_del').onclick = ()=> wrap.remove();
  return wrap;
}
function bc_mediaRow(type='', url=''){
  const wrap = document.createElement('div');
  wrap.style = 'display:grid;grid-template-columns:140px 1fr 80px;gap:8px;margin:6px 0';
  wrap.innerHTML = `
    <select class="bc_m_type">
      <option value="image"${type==='image'?' selected':''}>image</option>
      <option value="gif"${type==='gif'?' selected':''}>gif</option>
      <option value="sticker"${type==='sticker'?' selected':''}>sticker</option>
    </select>
    <input class="bc_m_url" placeholder="https://..." value="${url||''}">
    <button class="bc_m_del">Delete</button>
  `;
  wrap.querySelector('.bc_m_del').onclick = ()=> wrap.remove();
  return wrap;
}

async function bc_load(){
  const r = await fetch(BC_API); const j = await r.json();
  if(!j.ok){ document.getElementById('bc_msg').textContent = j.error||'Error'; return; }
  const d = j.data;

  document.getElementById('bc_enabled').value  = (d.enabled ? 'true':'false');
  document.getElementById('bc_typing').value   = (d.typingTitle ? 'true':'false');
  document.getElementById('bc_title').value    = d.title || '';
  document.getElementById('bc_name').value     = d.nameTag || '';
  document.getElementById('bc_footer').value   = d.footer || '';
  document.getElementById('bc_audience').value = d.audience || 'all';
  document.getElementById('bc_text').value     = d.textHtml || '';

  const cont = document.getElementById('bc_media'); cont.innerHTML='';
  (d.media||[]).forEach(m=> cont.appendChild(bc_mediaRow(m.type, m.url)));

  const cwrap = document.getElementById('bc_ctas'); cwrap.innerHTML='';
  if (Array.isArray(d.ctas) && d.ctas.length) {
    d.ctas.forEach(c => cwrap.appendChild(bc_ctaRow(c.label, c.href)));
  } else if (d.cta && d.cta.href) {
    cwrap.appendChild(bc_ctaRow(d.cta.label, d.cta.href)); // legacy single
  }

  document.getElementById('bc_msg').textContent='Loaded';
}

async function bc_save(){
  const media = [];
  document.querySelectorAll('#bc_media > div').forEach(row=>{
    const type = row.querySelector('.bc_m_type').value;
    const url  = row.querySelector('.bc_m_url').value.trim();
    if(url) media.push({type, url});
  });

  const ctas = [];
  document.querySelectorAll('#bc_ctas > div').forEach(row=>{
    const label = row.querySelector('.bc_c_label').value.trim() || 'Open';
    const href  = row.querySelector('.bc_c_href').value.trim();
    if(href) ctas.push({label, href});
  });

  const payload = {
    enabled:      document.getElementById('bc_enabled').value==='true',
    typingTitle:  document.getElementById('bc_typing').value==='true',
    title:        document.getElementById('bc_title').value.trim(),
    nameTag:      document.getElementById('bc_name').value.trim(),
    footer:       document.getElementById('bc_footer').value.trim(),
    audience:     document.getElementById('bc_audience').value,
    textHtml:     document.getElementById('bc_text').value,
    media,
    ctas
  };

  const r = await fetch(BC_API, {method:'POST', headers:BC_h(), body:JSON.stringify(payload)});
  const j = await r.json();
  document.getElementById('bc_msg').innerHTML = j.ok? '<span class="ok">Saved</span>' : ('<span class="err">'+(j.error||'Error')+'</span>');
  return j;
}

async function bc_preview(){
  const j = await bc_save();
  if(!j || !j.ok){ return; }

  // अगर user page पर popup widget script लोडेड है तो यह preview open करेगा:
  if(typeof AIBhaiPopup === 'function'){
    const inst = AIBhaiPopup({
      avatarUrl: 'https://deepakchauhanxai.xyz/images/AI-bhai.png',
      dataUrl: BC_API,
      position: 'br',
      accent: '#2dd4bf',
      pollSec: 0
    });
    inst.open && inst.open();
  } else {
    alert('Note: AIBhaiPopup widget script इस पेज पर नहीं है, इसलिए Preview तभी खुलेगा जब वो script जुड़ी हो।');
  }
}

document.getElementById('bc_add_media').onclick = ()=> document.getElementById('bc_media').appendChild(bc_mediaRow('image',''));
document.getElementById('bc_add_cta').onclick = ()=> document.getElementById('bc_ctas').appendChild(bc_ctaRow('Open','https://'));
document.getElementById('bc_add_whatsapp').onclick = ()=> document.getElementById('bc_ctas').appendChild(bc_ctaRow('Join WhatsApp','https://wa.me/91XXXXXXXXXX'));
document.getElementById('bc_load').onclick = bc_load;
document.getElementById('bc_save').onclick = ()=>bc_save();
document.getElementById('bc_preview').onclick = ()=>bc_preview();

/* ========= Boot ========= */
loadMembers();
bc_load();
</script>
<script src="https://deepakchauhanxai.com/scripts/ai_bhai_congratulations_popup.js"></script>
</body>
</html>
