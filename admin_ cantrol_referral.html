<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin — Referral Control Center</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #10b981;
      --dark: #0f172a;
      --darker: #0b1220;
      --card-dark: #1e293b;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #3b82f6;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #334155;
      --gradient-start: #6366f1;
      --gradient-end: #8b5cf6;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
      background: var(--darker);
      color: var(--text);
      line-height: 1.6;
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(37, 99, 235, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.1) 0%, transparent 20%);
    }
    
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Header Styles */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 22px;
      color: var(--text);
    }
    
    .logo i {
      color: var(--accent);
    }
    
    .admin-status {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--card-dark);
      padding: 8px 16px;
      border-radius: 50px;
      border: 1px solid var(--border);
    }
    
    .admin-status i {
      color: var(--accent);
    }
    
    /* Card Styles */
    .card {
      background: var(--card-dark);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
      border: 1px solid var(--border);
    }
    
    .section-title {
      font-size: 20px;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-title i {
      color: var(--accent);
    }
    
    /* Form Elements */
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    input, select, button {
      width: 100%;
      padding: 14px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--dark);
      color: var(--text);
      font-size: 16px;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    
    .btn {
      background: var(--primary);
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: var(--card-dark);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      background: var(--dark);
    }
    
    .btn-success {
      background: var(--success);
    }
    
    .btn-success:hover {
      background: #16a34a;
    }
    
    .btn-danger {
      background: var(--danger);
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    /* Grid System */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    
    @media (max-width: 968px) {
      .grid-3 {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }
    
    /* Stats Cards */
    .stat-card {
      background: linear-gradient(to bottom right, var(--card-dark), var(--dark));
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .stat-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(59, 130, 246, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
    }
    
    .stat-title {
      font-size: 14px;
      color: var(--text-muted);
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
    }
    
    /* Utility Classes */
    .text-muted {
      color: var(--text-muted);
      font-size: 14px;
    }
    
    .text-center {
      text-align: center;
    }
    
    .mt-20 {
      margin-top: 20px;
    }
    
    .mb-20 {
      margin-bottom: 20px;
    }
    
    .hide {
      display: none !important;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 50px;
      font-size: 12px;
      font-weight: 600;
      background: var(--dark);
      border: 1px solid var(--border);
    }
    
    /* Table Styles */
    .table-container {
      margin-top: 10px;
      overflow: auto;
      max-height: 380px;
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: var(--dark);
      text-align: left;
      padding: 12px;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-weight: 500;
    }
    
    .tab.active {
      border-bottom: 2px solid var(--accent);
      color: var(--accent);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card {
      animation: fadeIn 0.5s ease;
    }
    
    /* Status Indicators */
    .status-approved {
      color: var(--success);
    }
    
    .status-pending {
      color: var(--warning);
    }
    
    .status-rejected {
      color: var(--danger);
    }
    
    /* Action Buttons */
    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    .view-btn {
      background: var(--primary);
      color: white;
    }
    
    .view-btn:hover {
      background: var(--primary-dark);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <i class="fas fa-crown"></i>
        <span>Admin Control Center</span>
      </div>
      <div class="admin-status">
        <i class="fas fa-shield-alt"></i>
        <span>Administrator</span>
      </div>
    </header>

    <!-- Admin Key -->
    <div class="card">
      <h3 class="section-title"><i class="fas fa-key"></i> Admin Authentication</h3>
      <div class="grid-2">
        <div class="form-group">
          <label class="form-label"><i class="fas fa-lock"></i> Admin Key</label>
          <input id="adminkey" placeholder="X-ADMIN-KEY" />
        </div>
        <div class="form-group" style="display: flex; align-items: flex-end;">
          <button id="saveKey" class="btn"><i class="fas fa-save"></i> Save Key</button>
        </div>
      </div>
      <div id="keyMsg" class="text-muted"></div>
    </div>

    <!-- Work Create -->
    <div class="card">
      <h3 class="section-title"><i class="fas fa-tasks"></i> Work Creation</h3>
      <div class="grid-3">
        <div class="form-group">
          <label class="form-label"><i class="fas fa-user"></i> User Email</label>
          <input id="wc_email" placeholder="user@example.com" />
        </div>
        <div class="form-group">
          <label class="form-label"><i class="fas fa-indian-rupee-sign"></i> Amount (₹)</label>
          <input id="wc_amt" type="number" placeholder="0.00" step="0.01" />
        </div>
        <div class="form-group">
          <label class="form-label"><i class="fas fa-sticky-note"></i> Note</label>
          <input id="wc_note" placeholder="Work description" />
        </div>
      </div>
      <button id="wc_btn" class="btn btn-success"><i class="fas fa-plus-circle"></i> Create Work</button>
      <div id="wc_msg" class="text-muted mt-20"></div>
    </div>

    <!-- Work Approve/Reject/Reverse -->
    <div class="card">
      <h3 class="section-title"><i class="fas fa-check-circle"></i> Work Management</h3>
      <div class="grid-3">
        <div class="form-group">
          <label class="form-label"><i class="fas fa-id-badge"></i> Work ID</label>
          <input id="wa_id" type="number" placeholder="123" />
        </div>
        <div class="form-group">
          <label class="form-label"><i class="fas fa-cog"></i> Action</label>
          <select id="wa_action">
            <option value="APPROVE">APPROVE</option>
            <option value="REJECT">REJECT</option>
            <option value="REVERSE">REVERSE</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label"><i class="fas fa-sticky-note"></i> Note</label>
          <input id="wa_note" placeholder="Action reason" />
        </div>
      </div>
      <button id="wa_btn" class="btn"><i class="fas fa-paper-plane"></i> Submit Action</button>
      <div id="wa_msg" class="text-muted mt-20"></div>
    </div>

    <!-- Leaderboard Control -->
    <div class="card">
      <h3 class="section-title"><i class="fas fa-trophy"></i> Leaderboard Control</h3>
      <div class="grid-3">
        <div class="form-group">
          <label class="form-label"><i class="fas fa-grid"></i> Slot (1-10)</label>
          <input id="lb_slot" type="number" placeholder="1" min="1" max="10" />
        </div>
        <div class="form-group">
          <label class="form-label"><i class="fas fa-user"></i> User Email</label>
          <input id="lb_email" placeholder="user@example.com" />
        </div>
        <div class="form-group">
          <label class="form-label"><i class="fas fa-filter"></i> Mode</label>
          <select id="lb_mode">
            <option value="pin">Pin User</option>
            <option value="unpin">Unpin User</option>
            <option value="visibility">Change Visibility</option>
          </select>
        </div>
      </div>
      <div class="grid-2">
        <div class="form-group">
          <label class="form-label"><i class="fas fa-eye"></i> Visibility (1=Visible, 0=Hidden)</label>
          <input id="lb_visible" type="number" placeholder="1" min="0" max="1" />
        </div>
        <div class="form-group" style="display: flex; align-items: flex-end;">
          <button id="lb_btn" class="btn"><i class="fas fa-check-double"></i> Apply Changes</button>
        </div>
      </div>
      <div id="lb_msg" class="text-muted mt-20"></div>
    </div>

    <!-- Manual Wallet Adjust -->
    <div class="card">
      <h3 class="section-title"><i class="fas fa-wallet"></i> Manual Wallet Adjustment</h3>
      <div class="grid-3">
        <div class="form-group">
          <label class="form-label"><i class="fas fa-user"></i> User Email</label>
          <input id="ma_email" placeholder="user@example.com" />
        </div>
        <div class="form-group">
          <label class="form-label"><i class="fas fa-exchange-alt"></i> Type</label>
          <select id="ma_type">
            <option value="CREDIT">CREDIT</option>
            <option value="DEBIT">DEBIT</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label"><i class="fas fa-indian-rupee-sign"></i> Amount (₹)</label>
          <input id="ma_amt" type="number" placeholder="0.00" step="0.01" />
        </div>
      </div>
      <div class="grid-2">
        <div class="form-group">
          <label class="form-label"><i class="fas fa-sticky-note"></i> Reason / Note</label>
          <input id="ma_note" placeholder="Adjustment reason" />
        </div>
        <div class="form-group" style="display: flex; align-items: flex-end;">
          <button id="ma_btn" class="btn"><i class="fas fa-balance-scale"></i> Adjust Wallet</button>
        </div>
      </div>
      <div id="ma_msg" class="text-muted mt-20"></div>
    </div>

    <!-- Members Console -->
    <div class="card">
      <h3 class="section-title"><i class="fas fa-users"></i> Members Management</h3>
      <div class="grid-2">
        <div class="form-group">
          <label class="form-label"><i class="fas fa-search"></i> Search Members</label>
          <input id="m_q" placeholder="Search by name, email, or referral code" />
        </div>
        <div class="form-group" style="display: flex; align-items: flex-end; gap: 10px;">
          <button id="m_search" class="btn"><i class="fas fa-search"></i> Search</button>
          <button id="m_reset" class="btn btn-secondary"><i class="fas fa-undo"></i> Reset</button>
        </div>
      </div>
      <div class="text-muted" id="m_meta"></div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Ref Code</th>
              <th style="text-align: right;">Joinings</th>
              <th style="text-align: right;">Balance (₹)</th>
              <th style="text-align: right;">Action</th>
            </tr>
          </thead>
          <tbody id="m_rows"></tbody>
        </table>
      </div>

      <div class="grid-2 mt-20">
        <button id="m_prev" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Previous</button>
        <button id="m_next" class="btn btn-secondary">Next <i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Member Details Panel -->
    <div class="card" id="md_panel" style="display:none">
      <h3 class="section-title"><i class="fas fa-user-circle"></i> Member Details</h3>
      <div class="text-muted" id="md_head"></div>

      <div class="grid-3 mt-20">
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon">
              <i class="fas fa-users"></i>
            </div>
            <div>
              <div class="stat-title">Direct Joinings</div>
              <div class="stat-value" id="md_joinings">0</div>
            </div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon">
              <i class="fas fa-wallet"></i>
            </div>
            <div>
              <div class="stat-title">Balance</div>
              <div class="stat-value">₹<span id="md_balance">0.00</span></div>
            </div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div>
              <div class="stat-title">Total Commission</div>
              <div class="stat-value">₹<span id="md_totalc">0.00</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid-2 mt-20" style="gap: 20px;">
        <div>
          <h4 class="section-title"><i class="fas fa-cogs"></i> Quick Actions</h4>
          
          <div class="form-group">
            <label class="form-label">Adjustment Type</label>
            <select id="md_adj_type">
              <option value="CREDIT">CREDIT</option>
              <option value="DEBIT">DEBIT</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Amount (₹)</label>
            <input id="md_adj_amt" type="number" placeholder="0.00" step="0.01" />
          </div>
          
          <div class="form-group">
            <label class="form-label">Reason/Note</label>
            <input id="md_adj_note" placeholder="Adjustment reason" />
          </div>
          
          <button id="md_adj_btn" class="btn"><i class="fas fa-wallet"></i> Apply Adjustment</button>

          <div class="form-group mt-20">
            <label class="form-label">Leaderboard Visibility</label>
            <select id="md_vis_val">
              <option value="1">Visible in Leaderboard</option>
              <option value="0">Hide from Leaderboard</option>
            </select>
          </div>
          
          <button id="md_vis_btn" class="btn"><i class="fas fa-eye"></i> Save Visibility</button>

          <div class="form-group mt-20">
            <label class="form-label">Work Amount (₹)</label>
            <input id="md_work_amt" type="number" placeholder="0.00" step="0.01" />
          </div>
          
          <div class="form-group">
            <label class="form-label">Work Note</label>
            <input id="md_work_note" placeholder="Work description" />
          </div>
          
          <button id="md_work_create" class="btn btn-success"><i class="fas fa-plus"></i> Create Work</button>
        </div>

        <div>
          <h4 class="section-title"><i class="fas fa-history"></i> Recent Wallet Transactions</h4>
          <ul class="text-muted" id="md_wallet" style="list-style:none;padding:0;margin:0"></ul>

          <h4 class="section-title mt-20"><i class="fas fa-tasks"></i> Recent Works</h4>
          <ul class="text-muted" id="md_works" style="list-style:none;padding:0;margin:0"></ul>
        </div>
      </div>

      <div class="mt-20">
        <h4 class="section-title"><i class="fas fa-network-wired"></i> Direct Referees (last 50)</h4>
        <ul class="text-muted" id="md_refs" style="list-style:none;padding:0;margin:0"></ul>
      </div>
    </div>
  </div>

  <!-- Broadcast Popup -->
<div class="card">
  <h2>Broadcast Popup</h2>
  <div class="row">
    <select id="bc_enabled">
      <option value="true">Enabled</option>
      <option value="false">Disabled</option>
    </select>
    <select id="bc_typing">
      <option value="true">Typing Title ON</option>
      <option value="false">Typing Title OFF</option>
    </select>
  </div>
  <div class="row">
    <input id="bc_title" placeholder="Title" />
    <input id="bc_name" placeholder="Name Tag (e.g., Deepak Chauhan)" />
  </div>
  <div class="row">
    <input id="bc_footer" placeholder="Footer (e.g., — Admin Team)" />
    <select id="bc_audience">
      <option value="all">Audience: All</option>
      <option value="loggedin">Audience: Logged-in</option>
      <option value="new">Audience: New Users</option>
    </select>
  </div>

  <div style="margin-top:10px">
    <h4>Message (HTML allowed)</h4>
    <textarea id="bc_text" rows="5" style="width:100%;background:#0f1627;color:#e9edf5;border:1px solid #223154;border-radius:10px;padding:10px"></textarea>
  </div>

  <div style="margin-top:10px">
    <h4>Media (image/gif/sticker)</h4>
    <div id="bc_media"></div>
    <button id="bc_add_media">+ Add Media</button>
  </div>

  <div class="row" style="margin-top:10px">
    <input id="bc_cta_label" placeholder="CTA Label (optional)" />
    <input id="bc_cta_href"  placeholder="CTA Link (https://...)" />
  </div>
  
<div style="margin-top:10px">
  <h4>Buttons (CTAs)</h4>
  <div id="bc_ctas"></div>
  <div class="row" style="margin-top:6px">
    <button id="bc_add_cta">+ Add CTA</button>
    <button id="bc_add_whatsapp">+ Add WhatsApp</button>
  </div>
</div>
  
  <div class="row" style="margin-top:10px">
    <button id="bc_load">Load Current</button>
    <button id="bc_save">Save</button>
    <button id="bc_preview">Preview Popup</button>
  </div>
  <div id="bc_msg" class="muted"></div>
</div>
<script>
const API_BASE = 'https://deepakchauhanxai.xyz/referral/api';
const H = ()=>({'Content-Type':'application/json','X-ADMIN-KEY':(localStorage.getItem('admin_key')||'')});

document.getElementById('adminkey').value = localStorage.getItem('admin_key')||'';
document.getElementById('saveKey').onclick = ()=>{
  localStorage.setItem('admin_key', document.getElementById('adminkey').value.trim());
  document.getElementById('keyMsg').innerHTML='<span style="color:var(--success)">Admin key saved successfully</span>';
};

// Work Create
document.getElementById('wc_btn').onclick = async ()=>{
  const email = document.getElementById('wc_email').value.trim().toLowerCase();
  const amount_rupees = parseFloat(document.getElementById('wc_amt').value||'0');
  const note = document.getElementById('wc_note').value.trim();
  const res = await fetch(API_BASE+'/work_create.php',{method:'POST',headers:H(),body:JSON.stringify({email,amount_rupees,note})});
  const j = await res.json();
  document.getElementById('wc_msg').textContent = j.ok? ('Created work #'+j.data.work_id): (j.error||'Error');
};

// Work Approve/Reject/Reverse
document.getElementById('wa_btn').onclick = async ()=>{
  const work_id = parseInt(document.getElementById('wa_id').value||'0');
  const action = document.getElementById('wa_action').value;
  const note = document.getElementById('wa_note').value.trim();
  const res = await fetch(API_BASE+'/work_approve.php',{method:'POST',headers:H(),body:JSON.stringify({work_id,action,note})});
  const j = await res.json();
  document.getElementById('wa_msg').textContent = j.ok? ('Status: '+j.data.status): (j.error||'Error');
};

// Leaderboard Control
document.getElementById('lb_btn').onclick = async ()=>{
  const mode = document.getElementById('lb_mode').value;
  let payload = {mode};
  if(mode==='pin'){ payload.slot=parseInt(document.getElementById('lb_slot').value||'0'); payload.email=document.getElementById('lb_email').value.trim().toLowerCase(); }
  if(mode==='unpin'){ payload.slot=parseInt(document.getElementById('lb_slot').value||'0'); }
  if(mode==='visibility'){ payload.email=document.getElementById('lb_email').value.trim().toLowerCase(); payload.visible=parseInt(document.getElementById('lb_visible').value||'1'); }
  const res = await fetch(API_BASE+'/leaderboard_pin.php',{method:'POST',headers:H(),body:JSON.stringify(payload)});
  const j = await res.json();
  document.getElementById('lb_msg').textContent = j.ok? 'Done' : (j.error||'Error');
};

// Manual Adjust
document.getElementById('ma_btn').onclick = async ()=>{
  const email = document.getElementById('ma_email').value.trim().toLowerCase();
  const type = document.getElementById('ma_type').value;
  const amount_rupees = parseFloat(document.getElementById('ma_amt').value||'0');
  const note = document.getElementById('ma_note').value.trim();
  const res = await fetch(API_BASE+'/manual_adjust.php',{method:'POST',headers:H(),body:JSON.stringify({email,type,amount_rupees,note})});
  const j = await res.json();
  document.getElementById('ma_msg').textContent = j.ok? 'Adjusted' : (j.error||'Error');
};

// ===== Members Console =====
let M_PAGE = 1, M_LIMIT = 20, M_LAST_Q = '';
let MD_EMAIL = '';

function fmtINR(paise){ return (paise/100).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}); }

async function loadMembers(){
  const q = document.getElementById('m_q').value.trim();
  const url = `${API_BASE}/users_list.php?q=${encodeURIComponent(q)}&page=${M_PAGE}&limit=${M_LIMIT}`;
  const res = await fetch(url, { headers: H() });
  const j = await res.json();
  if(!j.ok){ document.getElementById('m_meta').textContent = j.error || 'Error'; return; }

  M_LAST_Q = q;
  const rows = j.data.users || [];
  const tb = document.getElementById('m_rows'); tb.innerHTML='';

  rows.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${u.name||''}</td>
      <td style="word-break:break-all">${u.email||''}</td>
      <td><span class="badge">${u.referral_code||''}</span></td>
      <td style="text-align:right">${u.direct_joinings}</td>
      <td style="text-align:right">₹${fmtINR(u.balance_paise||0)}</td>
      <td style="text-align:right">
        <button class="action-btn view-btn" data-email="${u.email}"><i class="fas fa-eye"></i> View</button>
      </td>
    `;
    tb.appendChild(tr);
  });

  document.getElementById('m_meta').textContent = `Total: ${j.data.total} • Page ${j.data.page}`;
  document.querySelectorAll('.view-btn').forEach(btn=>{
    btn.onclick = ()=> openMember(btn.getAttribute('data-email'));
  });
}

async function openMember(email){
  MD_EMAIL = email;
  const res = await fetch(`${API_BASE}/user_details.php?email=${encodeURIComponent(email)}`, { headers: H() });
  const j = await res.json(); if(!j.ok){ alert(j.error||'Error'); return; }

  const me = j.data.user, k = j.data.kpi;
  document.getElementById('md_head').textContent = `${me.name} • ${me.email} • Ref: ${me.referral_code}`;
  document.getElementById('md_joinings').textContent = k.direct_joinings;
  document.getElementById('md_balance').textContent = fmtINR(k.balance_paise||0);
  document.getElementById('md_totalc').textContent = fmtINR(k.total_commission_paise||0);

  const wul = document.getElementById('md_wallet'); wul.innerHTML='';
  (j.data.wallet_recent||[]).forEach(x=>{
    const ru = fmtINR(x.amount_paise||0);
    const sign = x.type==='CREDIT'?'+':'–';
    const li = document.createElement('li');
    li.innerHTML = `<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>${x.note||x.ref_type} <span class="text-muted">#${x.id}</span></span><span>${sign}₹${ru}</span></div>`;
    wul.appendChild(li);
  });

  const wl = document.getElementById('md_works'); wl.innerHTML='';
  (j.data.works_recent||[]).forEach(w=>{
    const amt = fmtINR(w.base_earning_paise||0);
    const statusClass = w.status === 'APPROVED' ? 'status-approved' : 
                       w.status === 'PENDING' ? 'status-pending' : 'status-rejected';
    const li = document.createElement('li');
    li.innerHTML = `<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>#${w.id} — <span class="${statusClass}">${w.status}</span></span><span class="text-muted">₹${amt}</span></div>`;
    wl.appendChild(li);
  });

  const rl = document.getElementById('md_refs'); rl.innerHTML='';
  (j.data.direct_referees||[]).forEach(r=>{
    const li = document.createElement('li');
    const dt = r.created_at ? new Date(r.created_at.replace(' ','T')).toLocaleDateString('en-IN') : '';
    li.innerHTML = `<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>${r.name||'User'} <span class="text-muted">${r.email}</span></span><span class="text-muted">${dt}</span></div>`;
    rl.appendChild(li);
  });

  document.getElementById('md_panel').style.display = 'block';
  document.getElementById('md_vis_val').value = me.leaderboard_visible || '1';
}

// members controls
document.getElementById('m_search').onclick = ()=>{ M_PAGE=1; loadMembers(); };
document.getElementById('m_reset').onclick = ()=>{ document.getElementById('m_q').value=''; M_PAGE=1; loadMembers(); };
document.getElementById('m_prev').onclick = ()=>{ if(M_PAGE>1){ M_PAGE--; loadMembers(); } };
document.getElementById('m_next').onclick = ()=>{ M_PAGE++; loadMembers(); };
document.getElementById('bc_add_cta').onclick = ()=>{
  document.getElementById('bc_ctas').appendChild(bc_ctaRow('Open','https://'));
  document.getElementById('bc_add_cta').onclick = ()=>{
  document.getElementById('bc_ctas').appendChild(bc_ctaRow('Open','https://'));
document.getElementById('bc_add_whatsapp').onclick = ()=>{
  document.getElementById('bc_ctas').appendChild(bc_ctaRow('Join WhatsApp','https://wa.me/91XXXXXXXXXX'));
};
// quick actions on detail
document.getElementById('md_adj_btn').onclick = async ()=>{
  if(!MD_EMAIL) return;
  const type = document.getElementById('md_adj_type').value;
  const amount_rupees = parseFloat(document.getElementById('md_adj_amt').value||'0');
  const note = document.getElementById('md_adj_note').value.trim();
  const res = await fetch(`${API_BASE}/manual_adjust.php`, { method:'POST', headers: H(), body: JSON.stringify({email:MD_EMAIL,type,amount_rupees,note})});
  const j = await res.json(); alert(j.ok?'Adjusted':(j.error||'Error'));
  if(j.ok){ openMember(MD_EMAIL); loadMembers(); }
};

document.getElementById('md_vis_btn').onclick = async ()=>{
  if(!MD_EMAIL) return;
  const visible = parseInt(document.getElementById('md_vis_val').value||'1');
  const res = await fetch(`${API_BASE}/leaderboard_pin.php`, { method:'POST', headers: H(), body: JSON.stringify({mode:'visibility', email:MD_EMAIL, visible})});
  const j = await res.json(); alert(j.ok?'Saved':(j.error||'Error'));
};

document.getElementById('md_work_create').onclick = async ()=>{
  if(!MD_EMAIL) return;
  const amount_rupees = parseFloat(document.getElementById('md_work_amt').value||'0');
  const note = document.getElementById('md_work_note').value.trim();
  const res = await fetch(`${API_BASE}/work_create.php`, { method:'POST', headers: H(), body: JSON.stringify({email:MD_EMAIL, amount_rupees, note})});
  const j = await res.json(); alert(j.ok?('Work #'+j.data.work_id+' created'):(j.error||'Error'));
  if(j.ok){ openMember(MD_EMAIL); }
};

// boot
loadMembers();

  // ===== Broadcast Admin =====
  function bc_ctaRow(label='', href=''){
  const wrap = document.createElement('div');
  wrap.style = 'display:grid;grid-template-columns:200px 1fr 80px;gap:8px;margin:6px 0';
  wrap.innerHTML = `
    <input class="bc_c_label" placeholder="Label (e.g., Join WhatsApp)" value="${label||''}">
    <input class="bc_c_href" placeholder="https://..." value="${href||''}">
    <button class="bc_c_del">Delete</button>
  `;
  wrap.querySelector('.bc_c_del').onclick = ()=> wrap.remove();
  return wrap;
  }
function BC_h(){ return {'Content-Type':'application/json','X-ADMIN-KEY':(localStorage.getItem('admin_key')||'')}; }
const BC_API = API_BASE + '/broadcast.php';

function bc_mediaRow(type='', url=''){
  const wrap = document.createElement('div');
  wrap.style = 'display:grid;grid-template-columns:140px 1fr 80px;gap:8px;margin:6px 0';
  wrap.innerHTML = `
    <select class="bc_m_type">
      <option value="image"${type==='image'?' selected':''}>image</option>
      <option value="gif"${type==='gif'?' selected':''}>gif</option>
      <option value="sticker"${type==='sticker'?' selected':''}>sticker</option>
    </select>
    <input class="bc_m_url" placeholder="https://..." value="${url||''}">
    <button class="bc_m_del">Delete</button>
  `;
  wrap.querySelector('.bc_m_del').onclick = ()=> wrap.remove();
  return wrap;
}

async function bc_load(){
  const r = await fetch(BC_API); const j = await r.json();
  if(!j.ok){ document.getElementById('bc_msg').textContent = j.error||'Error'; return; }
  const d = j.data;
  document.getElementById('bc_enabled').value = (d.enabled ? 'true':'false');
  document.getElementById('bc_typing').value  = (d.typingTitle ? 'true':'false');
  document.getElementById('bc_title').value   = d.title || '';
  document.getElementById('bc_name').value    = d.nameTag || '';
  document.getElementById('bc_footer').value  = d.footer || '';
  document.getElementById('bc_audience').value= d.audience || 'all';
  document.getElementById('bc_text').value    = d.textHtml || '';
  document.getElementById('bc_cta_label').value = (d.cta && d.cta.label) ? d.cta.label : '';
  document.getElementById('bc_cta_href').value  = (d.cta && d.cta.href)  ? d.cta.href  : '';

  const cont = document.getElementById('bc_media'); cont.innerHTML='';
  (d.media||[]).forEach(m=> cont.appendChild(bc_mediaRow(m.type, m.url)));
  document.getElementById('bc_msg').textContent='Loaded';
}
  // CTAs
  const cwrap = document.getElementById('bc_ctas'); 
  cwrap.innerHTML = '';
  if (Array.isArray(d.ctas) && d.ctas.length) {
    d.ctas.forEach(c => cwrap.appendChild(bc_ctaRow(c.label, c.href)));
  } else if (d.cta && d.cta.href) {
    // legacy single
    cwrap.appendChild(bc_ctaRow(d.cta.label, d.cta.href));
  }

async function bc_save(){
  const media = [];
  document.querySelectorAll('#bc_media > div').forEach(row=>{
    const type = row.querySelector('.bc_m_type').value;
    const url  = row.querySelector('.bc_m_url').value.trim();
    if(url) media.push({type, url});
  });
const ctas = [];
  document.querySelectorAll('#bc_ctas > div').forEach(row=>{
    const label = row.querySelector('.bc_c_label').value.trim() || 'Open';
    const href  = row.querySelector('.bc_c_href').value.trim();
    if(href) ctas.push({label, href});
  });
  const payload = {
    enabled:      document.getElementById('bc_enabled').value==='true',
    typingTitle:  document.getElementById('bc_typing').value==='true',
    title:        document.getElementById('bc_title').value.trim(),
    nameTag:      document.getElementById('bc_name').value.trim(),
    footer:       document.getElementById('bc_footer').value.trim(),
    audience:     document.getElementById('bc_audience').value,
    textHtml:     document.getElementById('bc_text').value,
    media,
    cta: (document.getElementById('bc_cta_href').value.trim()
         ? { label: document.getElementById('bc_cta_label').value.trim() || 'Open',
             href:  document.getElementById('bc_cta_href').value.trim() }
         : null)
  };

  const r = await fetch(BC_API, {method:'POST', headers:BC_h(), body:JSON.stringify(payload)});
  const j = await r.json();
  document.getElementById('bc_msg').innerHTML = j.ok? '<span class="ok">Saved</span>' : ('<span class="err">'+(j.error||'Error')+'</span>');
}

function bc_preview(){
  // current form → object
  const media = [];
  document.querySelectorAll('#bc_media > div').forEach(row=>{
    const type = row.querySelector('.bc_m_type').value;
    const url  = row.querySelector('.bc_m_url').value.trim();
    if(url) media.push({type, url});
  });
  const data = {
    enabled: document.getElementById('bc_enabled').value==='true',
    typingTitle: document.getElementById('bc_typing').value==='true',
    title: document.getElementById('bc_title').value.trim() || 'AI Bhai',
    nameTag: document.getElementById('bc_name').value.trim(),
    footer: document.getElementById('bc_footer').value.trim(),
    audience: document.getElementById('bc_audience').value,
    textHtml: document.getElementById('bc_text').value,
    media,
    cta: (document.getElementById('bc_cta_href').value.trim()
         ? { label: document.getElementById('bc_cta_label').value.trim() || 'Open',
             href:  document.getElementById('bc_cta_href').value.trim() }
         : null)
  };

  // widget preview (same avatar as widget)
  const avatar = 'https://deepakchauhanxai.xyz/images/AI-bhai.png';
  if(typeof AIBhaiPopup === 'function'){
    const inst = AIBhaiPopup({
      avatarUrl: avatar,
      dataUrl: BC_API, // not used in preview open
      position: 'br',
      accent: '#2dd4bf',
      pollSec: 0
    });
    // internal open with current data:
    // छोटा hack: widget के renderModal को reuse नहीं कर सकते तो एक बार saved data से open होने देंगे
    // इसलिए पहले save कर दो फिर open भी कर सकते हो — लेकिन बेहतर: widget को click करें:
    inst.open && inst.open(); // fallback open (will fetch from API)
  } else {
    alert('AIBhaiPopup script not loaded on this page.');
  }
}

// buttons
document.getElementById('bc_add_media').onclick = ()=> document.getElementById('bc_media').appendChild(bc_mediaRow('image',''));
document.getElementById('bc_load').onclick = bc_load;
document.getElementById('bc_save').onclick = bc_save;
document.getElementById('bc_preview').onclick = bc_preview;

// auto-load
bc_load();
</script>
</body>
</html>
