<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deepak √ó AI Bhai ‚Äî Referral</title>
  <style>
    :root{ --bg:#0b1220; --card:#121a2b; --line:#1c2740; --ink:#e9edf5; --muted:#a6b0c3; --accent:#2dd4bf; --chip:#1b2540; --chipline:#24345b; }
    *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);margin:0}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;gap:12px;justify-content:space-between;align-items:center;padding:6px 0}
    h1{font-size:20px;margin:0}
    .pill{background:var(--chip);border:1px solid var(--chipline);padding:6px 10px;border-radius:999px;font-size:12px;display:inline-flex;gap:8px;align-items:center}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0}
    .muted{color:var(--muted);font-size:13px}
    input,button,select{background:#0f1627;color:var(--ink);border:1px solid #223154;border-radius:10px;padding:10px 12px}
    input,select{width:100%} button{cursor:pointer}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:960px){ .grid-3{grid-template-columns:1fr} .grid-2{grid-template-columns:1fr} }
    .section-title{font-size:18px;margin:0 0 10px 0}
    .kpi{background:#16213a;border:1px solid #26406b;border-radius:14px;padding:14px}
    .kpi h4{margin:0 0 6px 0;font-size:14px;color:var(--muted);font-weight:600}
    .kpi .val{font-size:22px;font-weight:700}
    .bar{height:10px;background:#0f1627;border:1px solid #223154;border-radius:8px;overflow:hidden}
    .bar>div{height:100%;width:0%;background:var(--accent)}
    .list{list-style:none;margin:0;padding:0}
    .list li{display:flex;justify-content:space-between;gap:10px;padding:10px 6px;border-bottom:1px dashed #223154}
    .list li:last-child{border-bottom:0}
    .top3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:960px){ .top3{grid-template-columns:1fr} }
    .topcard{background:#16213a;border:1px solid #26406b;border-radius:16px;padding:14px;text-align:center}
    .rank{font-weight:800;font-size:24px}
    .chip{background:var(--chip);border:1px solid var(--chipline);padding:4px 8px;border-radius:8px;font-size:12px;display:inline-block}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){ .row{grid-template-columns:1fr} }
    .ok{color:#34d399} .err{color:#f87171} .hide{display:none !important}
    .toolbar{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="toolbar">
      <h1>Deepak Chauhan √ó AI Bhai ‚Äî Referral</h1>
      <span class="pill" id="loginInfo">Guest</span>
    </header>

    <div class="card">
      <b>Referral Code (‡§Ü‡§Æ‡§Ç‡§§‡•ç‡§∞‡§£):</b> <span id="refView">‚Äî</span>
      <span class="muted"> ‚Äî ‡§≤‡§ø‡§Ç‡§ï ‡§∏‡•á ‡§Ü‡§è ‡§π‡•ã ‡§§‡•ã ‡§Ö‡§™‡§®‡•á‚Äë‡§Ü‡§™ ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à</span>
    </div>

    <!-- AUTH BLOCKS -->
    <div class="card" id="authBlock">
      <h3 class="section-title">Sign up / Login</h3>

      <!-- Signup -->
      <div class="card" id="signupCard" style="margin:0 0 12px 0">
        <h4>‡§®‡§Ø‡§æ ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü</h4>
        <div class="row">
          <input id="su_name" placeholder="‡§®‡§æ‡§Æ" />
          <input id="su_email" placeholder="Email" type="email" />
        </div>
        <div class="row">
          <input id="su_pass" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° (6+ ‡§Ö‡§ï‡•ç‡§∑‡§∞)" type="password" />
          <div class="grid-2">
            <button id="su_getotp">Get OTP</button>
            <input id="su_otp" placeholder="OTP (6 digit)" />
          </div>
        </div>
        <div class="row">
          <button id="btnSignup">Create Account</button>
        </div>
        <div class="muted" id="signupMsg"></div>
      </div>

      <!-- Login -->
      <div class="card" id="loginCard" style="margin:0">
        <h4>Login (Email OTP)</h4>
        <div class="row">
          <input id="li_email" placeholder="Email" type="email" />
          <div class="grid-2">
            <button id="li_getotp">Get OTP</button>
            <input id="li_otp" placeholder="OTP (6 digit)" />
          </div>
        </div>
        <div class="row">
          <button id="btnLogin">Login</button>
        </div>
        <div class="muted" id="loginMsg"></div>
      </div>
    </div>

    <!-- Logged summary -->
    <div class="card hide" id="loggedCard">
      <div class="toolbar">
        <div><b>Logged in as:</b> <span id="loggedName">‚Äî</span> <span class="chip" id="loggedCode"></span></div>
        <div><button id="btnLogout">Logout</button></div>
      </div>
      <div class="muted" id="shareWrap">Share link: <span id="shareLink">‚Äî</span></div>
    </div>

    <!-- Profile -->
    <div class="card">
      <h3 class="section-title">‡§Æ‡•á‡§∞‡§æ ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤</h3>
      <div class="grid-3">
        <div class="kpi">
          <h4>Direct Joinings</h4>
          <div class="val" id="joinings">0</div>
          <div class="muted" style="margin:8px 0">Level Progress: 10 ‚Üí 50 ‚Üí 100 ‚Üí 160</div>
          <div class="bar"><div id="bar"></div></div>
        </div>
        <div class="kpi">
          <h4>Level Rate</h4>
          <div class="val"><span id="rate">0</span>%</div>
          <div class="muted">Auto unlock</div>
        </div>
        <div class="kpi">
          <h4>Wallet Balance</h4>
          <div class="val">‚Çπ<span id="balance">0.00</span></div>
          <div class="muted"><a href="#wallet">History ‡§¶‡•á‡§ñ‡•á‡§Ç</a></div>
        </div>
      </div>
    </div>

    <!-- Leaderboard -->
    <div class="card">
      <h3 class="section-title">Leaderboard</h3>
      <div class="top3" id="top3"></div>
      <ul class="list" id="next7"></ul>
    </div>

    <!-- Wallet -->
    <div class="card" id="wallet">
      <h3 class="section-title">Wallet History</h3>
      <ul class="list" id="walletList"></ul>
    </div>

    <div class="card">
      <h3 class="section-title">üîß Future Slot</h3>
      <div class="muted">‡§Ø‡§π‡§æ‡§Å ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‚ÄúMega Content / Training / Offers / Campaigns‚Äù ‡§ú‡•Å‡§°‡§º‡•á‡§Ç‡§ó‡•á‡•§ Layout ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•à‡•§</div>
    </div>
  </div>

<script>
const API_BASE = 'https://deepakchauhanxai.xyz/referral/api';

// capture ref
(function(){
  const u = new URL(location.href);
  const ref = (u.searchParams.get('ref') || '').toUpperCase();
  if(ref){ localStorage.setItem('ref_code', ref); }
  document.getElementById('refView').textContent = localStorage.getItem('ref_code') || '‚Äî';
})();

// state
let currentEmail = localStorage.getItem('my_email') || '';
let currentName  = localStorage.getItem('my_name')  || '';

function maskEmails(str){
  if(!str) return '';
  const emailRegex=/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/gi;
  return str.replace(emailRegex,'hidden');
}

function setLoggedUI(on){
  document.getElementById('authBlock').classList.toggle('hide', on);
  document.getElementById('loggedCard').classList.toggle('hide', !on);
  document.getElementById('loginInfo').textContent = on ? (currentName || 'User') : 'Guest';
}

// --- SIGNUP (OTP) ---
document.getElementById('su_getotp').onclick = async ()=>{
  const email = document.getElementById('su_email').value.trim().toLowerCase();
  if(!email){ alert('Email ‡§≠‡§∞‡•á‡§Ç'); return; }
  const r = await fetch(API_BASE+'/otp_request.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email, purpose:'REGISTER'})});
  const j = await r.json(); alert(j.ok?'OTP sent to email':(j.error||'Error'));
};

document.getElementById('btnSignup').onclick = async ()=>{
  const name = document.getElementById('su_name').value.trim();
  const email = document.getElementById('su_email').value.trim().toLowerCase();
  const password = document.getElementById('su_pass').value;
  const otp_code = document.getElementById('su_otp').value.trim();
  const ref = localStorage.getItem('ref_code') || '';
  const msg = document.getElementById('signupMsg');

  if(!name || !email || password.length<6 || !/^\d{6}$/.test(otp_code)){ msg.innerHTML='<span class="err">‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£ + OTP ‡§≠‡§∞‡•á‡§Ç</span>'; return; }

  const res = await fetch(API_BASE+'/register.php', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name,email,password,ref,otp_code})});
  const j = await res.json();
  if(!j.ok){ msg.innerHTML='<span class="err">'+(j.error||'Error')+'</span>'; return; }

  currentEmail=email; currentName=name;
  localStorage.setItem('my_email',email); localStorage.setItem('my_name',name);
  msg.innerHTML='<span class="ok">Account ‡§¨‡§® ‡§ó‡§Ø‡§æ</span>';
  afterLoginUI();
};

// --- LOGIN (OTP) ---
document.getElementById('li_getotp').onclick = async ()=>{
  const email = document.getElementById('li_email').value.trim().toLowerCase();
  if(!email){ alert('Email ‡§≠‡§∞‡•á‡§Ç'); return; }
  const r = await fetch(API_BASE+'/otp_request.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email, purpose:'LOGIN'})});
  const j = await r.json(); alert(j.ok?'OTP sent to email':(j.error||'Error'));
};

document.getElementById('btnLogin').onclick = async ()=>{
  const email = document.getElementById('li_email').value.trim().toLowerCase();
  const code  = document.getElementById('li_otp').value.trim();
  const msg = document.getElementById('loginMsg');
  if(!email || !/^\d{6}$/.test(code)){ msg.innerHTML='<span class="err">Email/OTP ‡§∏‡§π‡•Ä ‡§≠‡§∞‡•á‡§Ç</span>'; return; }

  const r = await fetch(API_BASE+'/login_verify.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email, code})});
  const j = await r.json();
  if(!j.ok){ msg.innerHTML='<span class="err">'+(j.error||'Error')+'</span>'; return; }

  currentEmail=j.data.email; currentName=j.data.name;
  localStorage.setItem('my_email',currentEmail); localStorage.setItem('my_name',currentName);
  msg.innerHTML='<span class="ok">Logged in</span>';
  afterLoginUI();
};

// --- After login
async function afterLoginUI(){
  setLoggedUI(true);
  await loadMe();
  await loadWallet();
  await loadLeaderboard();
}

document.getElementById('btnLogout').onclick = ()=>{
  localStorage.removeItem('my_email'); localStorage.removeItem('my_name');
  currentEmail=''; currentName='';
  setLoggedUI(false);
  // ‡§∏‡§æ‡§´ view
  document.getElementById('walletList').innerHTML='';
  document.getElementById('joinings').textContent='0';
  document.getElementById('rate').textContent='0';
  document.getElementById('balance').textContent='0.00';
  document.getElementById('bar').style.width='0%';
};

// --- Me
async function loadMe(){
  if(!currentEmail) return;
  const r = await fetch(API_BASE+'/me.php?email='+encodeURIComponent(currentEmail));
  const j = await r.json(); if(!j.ok) return;
  const me=j.data;

  currentName = me.name || currentName || currentEmail.split('@')[0];
  localStorage.setItem('my_name', currentName);

  setLoggedUI(true);
  document.getElementById('loggedName').textContent=currentName;
  document.getElementById('loginInfo').textContent=currentName;
  document.getElementById('loggedCode').textContent=me.referral_code;
  const share = location.origin + location.pathname + '?ref=' + me.referral_code;
  document.getElementById('shareLink').textContent = share;

  document.getElementById('joinings').textContent=me.direct_joinings;
  document.getElementById('rate').textContent=me.current_level_rate_percent;
  document.getElementById('balance').textContent=(me.balance_paise/100).toFixed(2);

  const J=me.direct_joinings, cap=J>=160?160: J>=100?100: J>=50?50:10;
  document.getElementById('bar').style.width = Math.min(100, Math.round((J/cap)*100))+'%';
}

// --- Wallet
async function loadWallet(){
  if(!currentEmail) return;
  const r = await fetch(API_BASE+'/wallet_history.php?email='+encodeURIComponent(currentEmail));
  const j = await r.json(); if(!j.ok) return;
  const ul=document.getElementById('walletList'); ul.innerHTML='';
  (j.data.entries||[]).forEach(x=>{
    const ru=(x.amount_paise/100).toFixed(2);
    const sign=x.type==='CREDIT'?'+':'-';
    const safeNote=maskEmails(x.note || x.ref_type);
    const li=document.createElement('li');
    li.innerHTML=`<span>${safeNote} <span class="muted">#${x.id}</span></span><span>${sign}‚Çπ${ru}</span>`;
    ul.appendChild(li);
  });
}

// --- Leaderboard
async function loadLeaderboard(){
  const r=await fetch(API_BASE+'/leaderboard.php'); const j=await r.json(); if(!j.ok) return;
  const t3=document.getElementById('top3'); t3.innerHTML='';
  (j.data.top3||[]).forEach((u,i)=>{
    const d=document.createElement('div'); d.className='topcard';
    d.innerHTML=`<div class="rank">#${i+1}</div><div>${u.name||'User'}</div><div class="muted">‚Çπ${(u.score_paise/100).toFixed(2)}</div>`;
    t3.appendChild(d);
  });
  const n7=document.getElementById('next7'); n7.innerHTML='';
  (j.data.next7||[]).forEach((u,i)=>{
    const li=document.createElement('li');
    li.innerHTML=`<span>#${i+4} ${u.name||'User'}</span><span class="muted">‚Çπ${(u.score_paise/100).toFixed(2)}</span>`;
    n7.appendChild(li);
  });
}

// boot
(function(){
  const ref = localStorage.getItem('ref_code') || ''; document.getElementById('refView').textContent = ref || '‚Äî';
  if(currentEmail){ setLoggedUI(true); afterLoginUI(); } else { setLoggedUI(false); }
  loadLeaderboard();
})();
</script>
</body>
</html>
