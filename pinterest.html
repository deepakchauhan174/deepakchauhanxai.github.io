<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üìå Admin Panel ‚Äî Pinterest Auto Uploader</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#9ca3af; --text:#e5e7eb; --accent:#22d3ee; --ok:#10b981; --bad:#ef4444; --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;background:linear-gradient(120deg,#0b1225,#111827 40%,#0b1225);color:var(--text)}
  header{padding:20px 16px;border-bottom:1px solid #1f2937;background:linear-gradient(180deg,#0f172a,#0b1225)}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:0;font-size:24px;display:flex;align-items:center;gap:8px}
  .sub{color:var(--muted);font-size:13px}
  .toolbar{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;margin-top:14px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .controls{padding:14px}
  input,select,button{height:40px;border-radius:10px;border:1px solid #334155;background:#0b1225;color:var(--text);padding:0 12px}
  input::placeholder{color:#64748b}
  button{cursor:pointer;border:none;background:linear-gradient(90deg,#06b6d4,#22d3ee);color:#04222a;font-weight:600;transition:.2s}
  button:hover{filter:brightness(1.05)}
  .btn-ghost{background:#0b1225;border:1px solid #334155;color:var(--text)}
  .table-wrap{overflow:auto;border-top:1px solid #1f2937}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:12px;border-bottom:1px solid #1f2937;vertical-align:top}
  th{position:sticky;top:0;background:#0b1225;z-index:1}
  .img{width:72px;height:72px;border-radius:10px;object-fit:cover;border:1px solid #334155}
  .status{padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid #334155;display:inline-block}
  .s-pending{background:#0b1225;color:#eab308}
  .s-processing{background:#0b1225;color:#22d3ee}
  .s-done{background:#062e26;color:#34d399;border-color:#065f46}
  .s-error{background:#2a0c0c;color:#fca5a5;border-color:#7f1d1d}
  .row-actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn-ok{background:linear-gradient(90deg,#059669,#10b981)}
  .btn-bad{background:linear-gradient(90deg,#ef4444,#f87171)}
  .badge{font-size:12px;color:#93c5fd}
  .link{color:#7dd3fc;text-decoration:none}
  .link:hover{text-decoration:underline}
  .footer{padding:14px;color:#94a3b8;text-align:center}
  .pill{padding:6px 10px;border-radius:999px;background:#0b1225;border:1px solid #334155;color:#cbd5e1;margin-left:8px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .hint{color:#a3a3a3;font-size:12px}
  .add-btn{background:linear-gradient(135deg,#0073e6,#005bb5);color:#fff;border:none;padding:12px 20px;font-size:16px;font-weight:bold;border-radius:8px;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,0.15);transition:all .3s}
  .add-btn:hover{background:linear-gradient(135deg,#005bb5,#003f88);transform:scale(1.05);box-shadow:0 6px 12px rgba(0,0,0,0.2)}
  .add-btn:active{transform:scale(0.97)}
  .top-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üìå Admin Panel <span class="pill mono" id="env">loading‚Ä¶</span></h1>
    <div class="sub">Pinterest Auto Uploader ‚Ä¢ Queue ‡§¶‡•á‡§ñ‡•á‡§Ç, ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç, Done/Delete ‡§ï‡§∞‡•á‡§Ç</div>

    <div class="top-actions">
      <!-- .com ‡§™‡§∞ ‡§∞‡§ñ‡§æ ‡§ó‡§Ø‡§æ add_pin.html ‡§ñ‡•ã‡§≤‡•á‡§ó‡§æ -->
      <button class="add-btn" onclick="window.location.href='/add_pin.html'">‚ûï Add New Pin</button>
      <!-- .com ‡§™‡§∞ ‡§∞‡§ñ‡§æ ‡§ó‡§Ø‡§æ add_member.html (‡§Ö‡§ó‡§∞ ‡§¨‡§®‡§æ‡§®‡§æ ‡§π‡•ã) -->
      <button class="add-btn" onclick="window.location.href='/add_member.html'">‚ûï Add New Member</button>
    </div>

    <div class="toolbar card controls">
      <input id="search" placeholder="Search: title / description / link / username" />
      <select id="status">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="processing">Processing</option>
        <option value="done">Done</option>
        <option value="error">Error</option>
      </select>
      <input id="date" type="date" />
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="refresh">Refresh</button>
        <button id="clear" class="btn-ghost">Clear Filters</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap card">
  <div class="table-wrap">
    <table id="grid">
      <thead>
        <tr>
          <th style="width:70px">ID</th>
          <th style="width:90px">Image</th>
          <th>Title & Description</th>
          <th>Link</th>
          <th>Board</th>
          <th>Member</th>
          <th>Scheduled</th>
          <th>Status</th>
          <th style="min-width:180px">Actions</th>
        </tr>
      </thead>
      <tbody id="body">
        <tr><td colspan="9" class="hint">Loading‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>
  <div class="footer">
    Tip: ‡§π‡§∞ Pin ‡§Æ‡•á‡§Ç website link auto ‡§π‡•ã‡§ó‡§æ ‚Äî <span class="mono">https://deepakchauhanxai.com</span>
  </div>
</div>

<script>
// ======== CONFIG (Backend API base ‚Äî .xyz) ========
const API_BASE = "https://deepakchauhanxai.xyz/pinterest";
// ================================================

const envEl = document.querySelector("#env");
envEl.textContent = new URL(API_BASE).host;

const $ = sel => document.querySelector(sel);
const tbody = $("#body");
const qSearch = $("#search");
const qStatus = $("#status");
const qDate = $("#date");
const btnRefresh = $("#refresh");
const btnClear = $("#clear");

let rows = []; // full data cache

btnRefresh.addEventListener("click", load);
btnClear.addEventListener("click", () => { qSearch.value=""; qStatus.value=""; qDate.value=""; render(); });
qSearch.addEventListener("input", render);
qStatus.addEventListener("change", render);
qDate.addEventListener("change", render);

// Load queue from API
async function load(){
  tbody.innerHTML = `<tr><td colspan="9" class="hint">Loading‚Ä¶</td></tr>`;
  try{
    const res = await fetch(`${API_BASE}/list_queue.php`, {mode:"cors", credentials:"omit"});
    const data = await res.json();

    // API ‡§ï‡§≠‡•Ä array ‡§¶‡•á‡§§‡§æ ‡§π‡•à, ‡§ï‡§≠‡•Ä {rows:[]} ‚Äî ‡§¶‡•ã‡§®‡•ã‡§Ç handle
    rows = Array.isArray(data) ? data : (data.rows || []);
    render();
  }catch(e){
    console.error(e);
    tbody.innerHTML = `<tr><td colspan="9" class="hint">Error loading data</td></tr>`;
  }
}

function render(){
  const term = qSearch.value.trim().toLowerCase();
  const st = qStatus.value;
  const day = qDate.value;

  let out = rows.filter(r=>{
    if(st && (r.status||"")!==st) return false;

    // scheduled_at ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§§‡•ã created_at ‡§≤‡•ã
    const scheduled = (r.scheduled_at && r.scheduled_at !== '0000-00-00 00:00:00')
      ? r.scheduled_at
      : (r.created_at || "");

    if(day && (!scheduled || !scheduled.startsWith(day))) return false;

    if(term){
      const hay = `${r.title||""} ${r.description||""} ${r.link||""} ${r.username||""}`.toLowerCase();
      if(!hay.includes(term)) return false;
    }
    return true;
  });

  if(!out.length){
    tbody.innerHTML = `<tr><td colspan="9" class="hint">No records found</td></tr>`;
    return;
  }

  tbody.innerHTML = out.map(r=>rowTpl(r)).join("");
}

function rowTpl(r){
  const s = (r.status||'pending').toLowerCase();
  const sCls = s==='done'?'s-done':s==='error'?'s-error':s==='processing'?'s-processing':'s-pending';

  const scheduled = (r.scheduled_at && r.scheduled_at !== '0000-00-00 00:00:00')
    ? r.scheduled_at
    : (r.created_at || '‚Äî');

  // ‡§ï‡•Å‡§õ APIs ‡§Æ‡•á‡§Ç board_id/board_name ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‚Äî fallback '‚Äî'
  const boardText = r.board_name || r.board_id || '‚Äî';
  const memberText = r.username ? `${r.username}` : (r.member_id ? `#${r.member_id}` : '‚Äî');

  return `
  <tr>
    <td class="mono">#${escapeHtml(r.id)}</td>
    <td>${r.image_url ? `<img class="img" src="${escapeAttr(r.image_url)}" alt="">` : '‚Äî'}</td>
    <td>
      <div class="mono badge">${escapeHtml(r.title||'')}</div>
      <div style="margin-top:6px;white-space:pre-wrap;line-height:1.3">${escapeHtml(r.description||'')}</div>
    </td>
    <td>
      ${r.link ? `<a class="link mono" href="${escapeAttr(r.link)}" target="_blank">${escapeHtml(r.link)}</a>` : '‚Äî'}
    </td>
    <td class="mono">${escapeHtml(boardText)}</td>
    <td class="mono">${escapeHtml(memberText)}</td>
    <td class="mono">${escapeHtml(scheduled)}</td>
    <td><span class="status ${sCls}">${escapeHtml(s)}</span></td>
    <td class="row-actions">
      <button class="btn-ok" onclick="markDone(${Number(r.id)})">Mark Done</button>
      <button class="btn-bad" onclick="delRow(${Number(r.id)})">Delete</button>
    </td>
  </tr>`;
}

function escapeHtml(s){return (s==null?'':String(s)).replace(/[&<>"]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]))}
function escapeAttr(s){return escapeHtml(s).replace(/"/g,"%22")}

async function markDone(id){
  if(!confirm("Mark as done?")) return;
  try{
    await fetch(`${API_BASE}/update_status.php?id=${encodeURIComponent(id)}&status=done`, {method:"GET", mode:"cors", credentials:"omit"});
    load();
  }catch(e){ alert("Failed to update."); }
}
async function delRow(id){
  if(!confirm("Delete this item?")) return;
  try{
    await fetch(`${API_BASE}/delete_queue.php?id=${encodeURIComponent(id)}`, {method:"GET", mode:"cors", credentials:"omit"});
    load();
  }catch(e){ alert("Failed to delete."); }
}

// auto load
load();
</script>
</body>
</html>
