<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Chat Room</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #6e8efb, #a777e3);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      width: 100%;
      max-width: 800px;
      height: 90vh;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    
    header {
      background: #4CAF50;
      color: white;
      padding: 15px 20px;
      text-align: center;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    #userName {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 20px;
      padding: 6px 12px;
      color: white;
      font-weight: bold;
      width: 120px;
    }
    
    #userName::placeholder {
      color: rgba(255, 255, 255, 0.8);
    }
    
    #onlineCount {
      background: rgba(0, 0, 0, 0.2);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 14px;
    }
    
    #chatBox {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #f9f9f9;
      display: flex;
      flex-direction: column;
    }
    
    #chatBox p {
      margin: 8px 0;
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
      max-width: 80%;
      position: relative;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .me { 
      background: #DCF8C6; 
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }
    
    .other { 
      background: #ffffff; 
      align-self: flex-start;
      border-bottom-left-radius: 5px;
      box-shadow: 0 1px 1px rgba(0,0,0,0.1);
    }
    
    .message-info {
      font-size: 12px;
      color: #888;
      margin-top: 4px;
      text-align: right;
    }
    
    .status {
      color: #666;
      font-style: italic;
      text-align: center;
      margin: 5px 0;
      background: transparent !important;
      align-self: center;
      max-width: 100% !important;
      font-size: 14px;
    }
    
    .controls-container {
      display: flex;
      padding: 15px;
      background: white;
      border-top: 1px solid #eee;
      gap: 10px;
      align-items: center;
    }
    
    #msg {
      flex: 1;
      padding: 14px 18px;
      border-radius: 24px;
      border: 1px solid #ddd;
      outline: none;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    #msg:focus {
      border-color: #4CAF50;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
    }
    
    #send, #fileBtn, #recordBtn {
      padding: 12px;
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      font-size: 18px;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.1s, background 0.3s;
    }
    
    #send { background: #4CAF50; }
    #fileBtn { background: #2196F3; }
    #recordBtn { background: #FF5722; }
    
    #send:hover { background: #45a049; transform: scale(1.05); }
    #fileBtn:hover { background: #1976D2; transform: scale(1.05); }
    #recordBtn:hover { background: #E64A19; transform: scale(1.05); }
    
    #recordBtn.recording {
      background: #f44336;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    #recordingIndicator {
      padding: 10px 15px;
      text-align: center;
      background: #ffebee;
      color: #f44336;
      font-weight: bold;
      display: none;
      font-size: 14px;
    }
    
    /* File type indicators */
    .file-message {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
    }
    
    .file-icon {
      font-size: 24px;
    }
    
    /* Login modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      text-align: center;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .modal h2 {
      margin-bottom: 20px;
      color: #4CAF50;
    }
    
    #userNameInput {
      width: 100%;
      padding: 14px;
      margin-bottom: 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      text-align: center;
    }
    
    #userNameInput:focus {
      border-color: #4CAF50;
      outline: none;
    }
    
    #joinChat {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    #joinChat:hover {
      background: #45a049;
    }
    
    /* Scrollbar styling */
    #chatBox::-webkit-scrollbar {
      width: 8px;
    }
    
    #chatBox::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    #chatBox::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    #chatBox::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* Media queries for responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        height: 95vh;
        border-radius: 12px;
      }
      
      header {
        padding: 12px 15px;
        border-radius: 12px 12px 0 0;
      }
      
      #chatBox p {
        max-width: 85%;
        padding: 10px 14px;
      }
      
      .btn-group {
        gap: 8px;
      }
      
      #send, #fileBtn, #recordBtn {
        width: 46px;
        height: 46px;
        font-size: 16px;
      }
      
      #msg {
        padding: 12px 16px;
      }
      
      .header-content h2 {
        font-size: 18px;
      }
    }
    
    @media (max-width: 480px) {
      .container {
        border-radius: 0;
        height: 100vh;
      }
      
      header {
        border-radius: 0;
      }
      
      #chatBox p {
        max-width: 90%;
      }
      
      .controls-container {
        padding: 12px;
      }
      
      .btn-group {
        gap: 6px;
      }
      
      #send, #fileBtn, #recordBtn {
        width: 44px;
        height: 44px;
      }
      
      #userName {
        width: 100px;
        font-size: 14px;
      }
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      body {
        background: linear-gradient(135deg, #2c3e50, #4a235a);
      }
      
      .container {
        background: #1e1e1e;
        color: #f0f0f0;
      }
      
      #chatBox {
        background: #121212;
      }
      
      .other {
        background: #2d2d2d;
        color: #f0f0f0;
      }
      
      .status {
        color: #aaa;
      }
      
      #msg {
        background: #2d2d2d;
        color: #f0f0f0;
        border-color: #444;
      }
      
      .controls-container {
        background: #1e1e1e;
        border-color: #333;
      }
      
      /* Scrollbar for dark mode */
      #chatBox::-webkit-scrollbar-track {
        background: #2d2d2d;
      }
      
      #chatBox::-webkit-scrollbar-thumb {
        background: #555;
      }
      
      #chatBox::-webkit-scrollbar-thumb:hover {
        background: #777;
      }
    }
  </style>
</head>
<body>

<!-- Login Modal -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <h2>‡§ö‡•à‡§ü ‡§∞‡•Ç‡§Æ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à</h2>
    <input type="text" id="userNameInput" placeholder="‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" maxlength="20">
    <button id="joinChat">‡§ö‡•à‡§ü ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç</button>
  </div>
</div>

<div class="container">
  <header>
    <div class="header-content">
      <h2>üí¨ Live Chat Room</h2>
      <div class="user-info">
        <input type="text" id="userName" placeholder="‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ" readonly>
        <span id="onlineCount">0 Online</span>
      </div>
    </div>
  </header>
  
  <div id="chatBox">
    <p class="status">‡§ö‡•à‡§ü ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</p>
  </div>
  
  <div id="recordingIndicator">Recording... Click again to stop</div>
  
  <div class="controls-container">
    <input type="text" id="msg" placeholder="Type a message..." disabled>
    <div class="btn-group">
      <button id="fileBtn" title="Attach file">üìé</button>
      <button id="recordBtn" title="Record audio">üé§</button>
      <button id="send" title="Send message">‚û§</button>
    </div>
  </div>
</div>

<!-- hidden file input -->
<input type="file" id="fileInput" style="display:none">

<script>
// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
  const API_SEND = "https://deepakchauhanxai.xyz/sendMessage.php";
  const API_GET  = "https://deepakchauhanxai.xyz/getMessages.php";

  // Current User
  let currentUser = "";
  
  // Audio recording variables
  let mediaRecorder = null;
  let audioChunks = [];
  let isRecording = false;
  
  // Track if we're at the bottom of the chat
  let isAtBottom = true;
  
  // DOM Elements
  const loginModal = document.getElementById("loginModal");
  const userNameInput = document.getElementById("userNameInput");
  const joinChatBtn = document.getElementById("joinChat");
  const userNameDisplay = document.getElementById("userName");
  const msgInput = document.getElementById("msg");
  const sendBtn = document.getElementById("send");
  const fileBtn = document.getElementById("fileBtn");
  const recordBtn = document.getElementById("recordBtn");
  const fileInput = document.getElementById("fileInput");
  const chatBox = document.getElementById("chatBox");
  const recordingIndicator = document.getElementById("recordingIndicator");
  const onlineCount = document.getElementById("onlineCount");

  // =============== USER LOGIN ==================
  joinChatBtn.addEventListener("click", function() {
    const name = userNameInput.value.trim();
    if (name) {
      currentUser = name;
      userNameDisplay.value = currentUser;
      loginModal.style.display = "none";
      msgInput.disabled = false;
      loadMessages();
    } else {
      userNameInput.focus();
    }
  });

  userNameInput.addEventListener("keypress", function(e) {
    if (e.key === 'Enter') {
      joinChatBtn.click();
    }
  });

  // Focus on input when modal opens
  userNameInput.focus();

  // =============== TEXT MESSAGE SEND ==================
  sendBtn.addEventListener("click", sendMessage);
  
  // Allow sending message with Enter key
  msgInput.addEventListener("keypress", function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
  
  // Check if user is scrolled to bottom
  chatBox.addEventListener("scroll", function() {
    isAtBottom = chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < 50;
  });

  function sendMessage(){
    let msg = msgInput.value;
    
    if(msg.trim() === "") return;
    
    // Show sending status
    chatBox.innerHTML += `<p class="me status"><b>${currentUser}:</b> ‡§≠‡•á‡§ú ‡§∞‡§π‡§æ ‡§π‡•à...</p>`;
    chatBox.scrollTop = chatBox.scrollHeight;

    fetch(API_SEND, {
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        sender: currentUser, 
        message: msg, 
        type: "text", 
        file: ""
      })
    })
    .then(res => {
      if (!res.ok) {
        throw new Error('Network response was not ok');
      }
      return res.text();
    })
    .then(() => {
      msgInput.value = "";
      loadMessages();
    })
    .catch(error => {
      console.error('Error:', error);
      chatBox.innerHTML += `<p class="status">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≠‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§´‡§≤</p>`;
    });
  }

  // =============== FILE MESSAGE SEND ==================
  fileBtn.addEventListener("click", ()=>{
     fileInput.click();
  });

  fileInput.addEventListener("change", function(){
     if(this.files.length > 0){
        sendFile(this.files[0]);
        // Reset file input
        this.value = '';
     }
  });

  function sendFile(file){
     chatBox.innerHTML += `<p class="me status"><b>${currentUser}:</b> ‡§´‡§º‡§æ‡§á‡§≤ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à...</p>`;
     chatBox.scrollTop = chatBox.scrollHeight;
     
     let formData = new FormData();
     formData.append("sender", currentUser);
     formData.append("message", file.name);
     formData.append("type", getFileType(file.name));
     formData.append("file", file);

     fetch(API_SEND, {
       method: "POST",
       body: formData
     })
     .then(res => {
       if (!res.ok) {
         throw new Error('Network response was not ok');
       }
       return res.text();
     })
     .then(() => {
        loadMessages();
     })
     .catch(error => {
        console.error('Error:', error);
        chatBox.innerHTML += `<p class="status">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§´‡§º‡§æ‡§á‡§≤ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§´‡§≤</p>`;
     });
  }

  function getFileType(name){
    let ext = name.split(".").pop().toLowerCase();
    if(["jpg","jpeg","png","gif","webp"].includes(ext)) return "image";
    if(["mp3","wav","ogg"].includes(ext)) return "audio";
    if(["mp4","webm","mkv"].includes(ext)) return "video";
    return "file";
  }

  // =============== AUDIO RECORDING FUNCTIONALITY ==================
  recordBtn.addEventListener('click', toggleRecording);
  
  async function toggleRecording() {
    if (!isRecording) {
      // Start recording
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const audioFile = new File([audioBlob], 'recording.webm', { type: 'audio/webm' });
          
          // Send the recorded audio
          sendAudio(audioFile);
          
          // Stop all tracks
          stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        isRecording = true;
        recordBtn.classList.add('recording');
        recordingIndicator.style.display = 'block';
      } catch (error) {
        console.error('Error accessing microphone:', error);
        alert('‡§Æ‡§æ‡§á‡§ï‡•ç‡§∞‡•ã‡§´‡§º‡•ã‡§® ‡§§‡§ï ‡§™‡§π‡•Å‡§Ç‡§ö‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§Ç‡•§');
      }
    } else {
      // Stop recording
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        isRecording = false;
        recordBtn.classList.remove('recording');
        recordingIndicator.style.display = 'none';
      }
    }
  }
  
  function sendAudio(audioFile) {
    chatBox.innerHTML += `<p class="me status"><b>${currentUser}:</b> ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§≠‡•á‡§ú ‡§∞‡§π‡§æ ‡§π‡•à...</p>`;
    chatBox.scrollTop = chatBox.scrollHeight;
    
    let formData = new FormData();
    formData.append("sender", currentUser);
    formData.append("message", "Audio recording");
    formData.append("type", "audio");
    formData.append("file", audioFile);

    fetch(API_SEND, {
      method: "POST",
      body: formData
    })
    .then(res => {
      if (!res.ok) {
        throw new Error('Network response was not ok');
      }
      return res.text();
    })
    .then(() => {
      loadMessages();
    })
    .catch(error => {
      console.error('Error:', error);
      chatBox.innerHTML += `<p class="status">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§≠‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§´‡§≤</p>`;
    });
  }

  // =============== LOAD MESSAGES ==================
  function loadMessages(){
    fetch(API_GET)
    .then(res => {
      if (!res.ok) {
        throw new Error('Network response was not ok');
      }
      return res.json();
    })
    .then(data => {
      const previousScrollHeight = chatBox.scrollHeight;
      const previousScrollTop = chatBox.scrollTop;
      
      chatBox.innerHTML = "";
      
      if (data.length === 0) {
        chatBox.innerHTML = `<p class="status">‡§ï‡•ã‡§à ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§™‡§π‡§≤‡§æ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≠‡•á‡§ú‡•á‡§Ç!</p>`;
        return;
      }
      
      data.forEach(m => {
        let cls = (m.sender === currentUser) ? "me" : "other";
        let content = "";

        if(m.type === "text"){
          content = m.message;
        } else if(m.type === "image"){
          content = `<img src="https://deepakchauhanxai.xyz/${m.file}" width="200" style="border-radius: 8px; max-width: 100%;">`;
        } else if(m.type === "audio"){
          content = `<audio controls src="https://deepakchauhanxai.xyz/${m.file}" style="width: 250px; max-width: 100%; margin: 5px 0;"></audio>`;
        } else if(m.type === "video"){
          content = `<video controls width="250" src="https://deepakchauhanxai.xyz/${m.file}" style="border-radius: 8px; max-width: 100%;"></video>`;
        } else {
          content = `<div class="file-message">
                      <span class="file-icon">üìÑ</span>
                      <a href="https://deepakchauhanxai.xyz/${m.file}" target="_blank" style="color: #2196F3; text-decoration: none;">${m.message || 'Download File'}</a>
                    </div>`;
        }

        // Add timestamp if available
        const timestamp = m.timestamp ? new Date(m.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
        
        chatBox.innerHTML += `<p class="${cls}"><b>${m.sender}:</b><br>${content}<div class="message-info">${timestamp}</div></p>`;
      });
      
      // Auto-scroll only if user was at bottom before update
      if (isAtBottom) {
        chatBox.scrollTop = chatBox.scrollHeight;
      }
      
      // Update online count (simulated)
      onlineCount.textContent = `${Math.floor(Math.random() * 10) + 1} Online`;
    })
    .catch(error => {
      console.error('Error:', error);
      chatBox.innerHTML = `<p class="status">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§´‡§≤</p>`;
    });
  }

  // Auto refresh
  setInterval(loadMessages, 3000);
});
</script>

</body>
</html>
