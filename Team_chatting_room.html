<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>My Chat Room</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 20px;
    }
    #chatBox {
      width: 90%;
      max-width: 500px;
      height: 400px;
      border: 1px solid #ccc;
      border-radius: 10px;
      margin: 20px auto;
      padding: 10px;
      overflow-y: scroll;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #chatBox p {
      margin: 5px 0;
      padding: 6px 10px;
      border-radius: 8px;
      word-wrap: break-word;
    }
    .me { background: #DCF8C6; text-align: right; }
    .other { background: #f1f1f1; text-align: left; }
    #controls {
      width: 90%;
      max-width: 500px;
      display: flex;
      margin-bottom: 20px;
      gap: 5px;
    }
    #msg {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #send, #fileBtn {
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    #fileBtn { background: #2196F3; }
    #send:hover { background: #45a049; }
    #fileBtn:hover { background: #1976D2; }
    .status {
      color: #666;
      font-style: italic;
      text-align: center;
      margin: 5px 0;
    }
  </style>
</head>
<body>

<h2>üí¨ Live Chat Room</h2>

<div id="chatBox">
  <p class="status">‡§ö‡•à‡§ü ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</p>
</div>

<div id="controls">
  <input type="text" id="msg" placeholder="Type a message...">
  <button id="send">Send</button>
  <button id="fileBtn">üìé</button>
</div>

<!-- hidden file input -->
<input type="file" id="fileInput" style="display:none">

<script>
// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
  const API_SEND = "https://deepakchauhanxai.xyz/sendMessage.php";
  const API_GET  = "https://deepakchauhanxai.xyz/getMessages.php";

  // Current User (testing ke liye fix, baad me login se change kar dena)
  let currentUser = "Deepak";

  // =============== TEXT MESSAGE SEND ==================
  document.getElementById("send").addEventListener("click", sendMessage);
  
  // Allow sending message with Enter key
  document.getElementById("msg").addEventListener("keypress", function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  function sendMessage(){
    let msgInput = document.getElementById("msg");
    let msg = msgInput.value;
    
    if(msg.trim() === "") return;
    
    // Show sending status
    let chatBox = document.getElementById("chatBox");
    chatBox.innerHTML += `<p class="me status"><b>${currentUser}:</b> ‡§≠‡•á‡§ú ‡§∞‡§π‡§æ ‡§π‡•à...</p>`;
    chatBox.scrollTop = chatBox.scrollHeight;

    fetch(API_SEND, {
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        sender: currentUser, 
        message: msg, 
        type: "text", 
        file: ""
      })
    })
    .then(res => {
      if (!res.ok) {
        throw new Error('Network response was not ok');
      }
      return res.text();
    })
    .then(() => {
      msgInput.value = "";
      loadMessages();
    })
    .catch(error => {
      console.error('Error:', error);
      chatBox.innerHTML += `<p class="status">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≠‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§´‡§≤</p>`;
    });
  }

  // =============== FILE MESSAGE SEND ==================
  document.getElementById("fileBtn").addEventListener("click", ()=>{
     document.getElementById("fileInput").click();
  });

  document.getElementById("fileInput").addEventListener("change", function(){
     if(this.files.length > 0){
        sendFile(this.files[0]);
        // Reset file input
        this.value = '';
     }
  });

  function sendFile(file){
     let chatBox = document.getElementById("chatBox");
     chatBox.innerHTML += `<p class="me status"><b>${currentUser}:</b> ‡§´‡§º‡§æ‡§á‡§≤ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à...</p>`;
     chatBox.scrollTop = chatBox.scrollHeight;
     
     let formData = new FormData();
     formData.append("sender", currentUser);
     formData.append("message", "");
     formData.append("type", getFileType(file.name));
     formData.append("file", file);

     fetch(API_SEND, {
       method: "POST",
       body: formData
     })
     .then(res => {
       if (!res.ok) {
         throw new Error('Network response was not ok');
       }
       return res.text();
     })
     .then(() => {
        loadMessages();
     })
     .catch(error => {
        console.error('Error:', error);
        chatBox.innerHTML += `<p class="status">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§´‡§º‡§æ‡§á‡§≤ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§´‡§≤</p>`;
     });
  }

  function getFileType(name){
    let ext = name.split(".").pop().toLowerCase();
    if(["jpg","jpeg","png","gif","webp"].includes(ext)) return "image";
    if(["mp3","wav","ogg"].includes(ext)) return "audio";
    if(["mp4","webm","mkv"].includes(ext)) return "video";
    return "file";
  }

  // =============== LOAD MESSAGES ==================
  function loadMessages(){
    fetch(API_GET)
    .then(res => {
      if (!res.ok) {
        throw new Error('Network response was not ok');
      }
      return res.json();
    })
    .then(data => {
      let chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";
      
      if (data.length === 0) {
        chatBox.innerHTML = `<p class="status">‡§ï‡•ã‡§à ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§™‡§π‡§≤‡§æ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≠‡•á‡§ú‡•á‡§Ç!</p>`;
        return;
      }
      
      data.forEach(m => {
        let cls = (m.sender === currentUser) ? "me" : "other";
        let content = "";

        if(m.type === "text"){
          content = m.message;
        } else if(m.type === "image"){
          content = `<img src="https://deepakchauhanxai.xyz/${m.file}" width="200">`;
        } else if(m.type === "audio"){
          content = `<audio controls src="https://deepakchauhanxai.xyz/${m.file}"></audio>`;
        } else if(m.type === "video"){
          content = `<video controls width="250" src="https://deepakchauhanxai.xyz/${m.file}"></video>`;
        } else {
          content = `<a href="https://deepakchauhanxai.xyz/${m.file}" target="_blank">Download File</a>`;
        }

        chatBox.innerHTML += `<p class="${cls}"><b>${m.sender}:</b><br>${content}</p>`;
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    })
    .catch(error => {
      console.error('Error:', error);
      let chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = `<p class="status">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§´‡§≤</p>`;
    });
  }

  // Auto refresh
  setInterval(loadMessages, 2000);
  loadMessages();
});
</script>

</body>
</html>
